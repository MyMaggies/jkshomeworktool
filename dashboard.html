<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f7fa; 
            padding: 20px; 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            border-radius: 10px; 
            margin-bottom: 30px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .header h1 { margin-bottom: 10px; }
        .header p { opacity: 0.9; margin-bottom: 20px; }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: #e2e8f0;
            border: none;
            color: #4a5568;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        /* Tabs Content */
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-content.active {
            display: block;
        }

        /* Student Engagement Tab */
        .engagement-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            margin-bottom: 10px;
            color: #4a5568;
            font-size: 16px;
        }
        .stat-card .number {
            font-size: 36px;
            color: #667eea;
            font-weight: bold;
        }

        /* Student Details Table */
        .student-details {
            width: 100%;
            border-collapse: collapse;
        }
        .student-details th, 
        .student-details td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        .student-details th {
            background: #f8f9fa;
            font-weight: bold;
            color: #4a5568;
        }

        /* Existing styles from original dashboard.html */
        .teacher-input-box { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .teacher-input-box label { display: block; margin-bottom: 8px; font-weight: 600; }
        .teacher-input-box input { width: 100%; max-width: 400px; padding: 10px; border: none; border-radius: 5px; font-size: 16px; }
        .btn { padding: 15px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 16px; display: inline-block; }
        .btn-danger { background: #f56565; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Teacher Dashboard</h1>
        <p>Student Quiz Analytics & Homework Notification System</p>
        
        <div class="teacher-input-box">
            <label for="headerTeacherName">Your Name (for PDF signatures):</label>
            <input type="text" id="headerTeacherName" placeholder="e.g., Mr. Louis Pienaar" onchange="updateTeacherName()">
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('engagement')">Student Engagement</button>
        <button class="tab-btn" onclick="switchTab('homework')">Homework Letters</button>
    </div>

    <!-- Student Engagement Tab -->
    <div id="engagementTab" class="tab-content active">
        <div class="engagement-stats">
            <div class="stat-card">
                <h3>Total Students</h3>
                <div class="number" id="totalStudentsEngagement">0</div>
            </div>
            <div class="stat-card">
                <h3>Average Score</h3>
                <div class="number" id="averageScore">0%</div>
            </div>
            <div class="stat-card">
                <h3>Total Quiz Attempts</h3>
                <div class="number" id="totalQuizAttempts">0</div>
            </div>
            <div class="stat-card">
                <h3>Avg Time per Quiz</h3>
                <div class="number" id="averageQuizTime">0s</div>
            </div>
        </div>

        <h2>Detailed Student Performance</h2>
        <table class="student-details" id="studentDetailsTable">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Score</th>
                    <th>Time Taken</th>
                    <th>Tab Switches</th>
                    <th>Copy Attempts</th>
                </tr>
            </thead>
            <tbody id="studentDetailsBody">
                <!-- Rows will be dynamically populated -->
            </tbody>
        </table>
    </div>

    <!-- Homework Letters Tab (Existing Content) -->
    <div id="homeworkTab" class="tab-content">
        <!-- Existing homework letters section from original dashboard -->
        <div class="main-section">
            <h2>ðŸ“‹ Generate Homework Letters</h2>
            
            <div class="alert alert-info">
                <strong>How it works:</strong> System automatically loads classlist.xlsx and compares with quiz database. PDFs generated for students who: didn't take quiz, scored &lt;70%, or didn't complete.
            </div>

            <!-- Rest of the existing homework letters section remains the same -->
            <div id="systemStatus" class="alert alert-info">
                <span class="status-indicator loading"></span>
                <strong>Loading...</strong> Checking class list and database...
            </div>

            <!-- Existing form groups, generate button, etc. from original dashboard -->
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qedepuxzmdchujbipgax.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_JdSxu3gnEDIFaNtB1K4PNg_vqj0WoOI';

        function switchTab(tabName) {
            // Remove active class from all tabs and tab buttons
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Add active class to selected tab and button
            document.getElementById(`${tabName}Tab`).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        async function fetchQuizData() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts?select=*`, {
                    headers: { 
                        'apikey': SUPABASE_KEY, 
                        'Authorization': `Bearer ${SUPABASE_KEY}` 
                    }
                });
                const quizData = await response.json();
                
                // Process Engagement Statistics
                const totalStudents = new Set(quizData.map(q => q.student_name)).size;
                const completedAttempts = quizData.filter(q => q.completed);
                const averageScore = completedAttempts.length 
                    ? (completedAttempts.reduce((sum, q) => sum + q.score, 0) / completedAttempts.length).toFixed(1)
                    : 0;
                const averageTime = completedAttempts.length
                    ? (completedAttempts.reduce((sum, q) => sum + q.time_seconds, 0) / completedAttempts.length).toFixed(1)
                    : 0;

                // Update Engagement Stats
                document.getElementById('totalStudentsEngagement').textContent = totalStudents;
                document.getElementById('averageScore').textContent = `${averageScore}%`;
                document.getElementById('totalQuizAttempts').textContent = quizData.length;
                document.getElementById('averageQuizTime').textContent = `${averageTime}s`;

                // Populate Student Details Table
                const tableBody = document.getElementById('studentDetailsBody');
                tableBody.innerHTML = ''; // Clear existing rows

                quizData.forEach(quiz => {
                    const row = `
                        <tr>
                            <td>${quiz.student_name}</td>
                            <td>${quiz.score}%</td>
                            <td>${quiz.time_seconds}s</td>
                            <td>${quiz.tab_switches}</td>
                            <td>${quiz.copy_attempts}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

            } catch (error) {
                console.error('Error fetching quiz data:', error);
            }
        }

        // Retain all existing functions from original dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            loadSavedTeacherName();
            loadSavedAssignment();
            await initializeSystem();
            await fetchQuizData(); // New function to load engagement data
        });

        // Rest of the script from original dashboard remains the same
    </script>

    <!-- Retain all existing script from original dashboard -->
</body>
</html>
